---
title: View and edit your security settings in Microsoft Defender for Business
description: View and edit security policies and settings in Defender for Business
search.appverid: MET150
author: siosulli
ms.author: siosulli
manager: dansimp
audience: Admin
ms.topic: conceptual
ms.service: microsoft-365-security
ms.subservice: mdvm
ms.localizationpriority: medium
ms.date: 05/12/2022
ms.collection:
 - m365-security
 - m365-security-compliance
 - tier1

---

# Windows authenticated scan


[!INCLUDE [Microsoft 365 Defender rebranding](../../includes/microsoft-defender.md)]

**Applies to:**

- [Microsoft Defender for Endpoint Plan 2](https://go.microsoft.com/fwlink/?linkid=2154037)
- [Microsoft Defender Vulnerability Management](index.yml)
- [Microsoft 365 Defender](https://go.microsoft.com/fwlink/?linkid=2118804)

[!include[Prerelease information](../../includes/prerelease.md)]

>[!Note]
>Want to experience Microsoft Defender Vulnerability Management? Learn more about how you can sign up to the [Microsoft Defender Vulnerability Management public preview trial](../defender-vulnerability-management/get-defender-vulnerability-management.md).

Windows authenticated scan provides the ability to remotely target by IP ranges and scan Windows services by providing Microsoft Defender Vulnerability Management with credentials to remotely access the machines.

This is applicable for devices that do not have the Defender Vulnerability Management or Defender for Endpoint agent deployed.

## Scanner Installation

Similar to network device authenticated scan you'll need a scanning device with the scanner installed. If you don’t already have the network scanner installed, see [Network device discovery and vulnerability management.](../defender-endpoint/network-devices?view=o365-worldwide#install-the-network-scanner) for steps on how to download and install the network scanner.

>[!NOTE]
> No changes are required for pre-existing scanners installed.

## Pre-requisites

The following section lists the pre-requisites you need to configure to use Windows authenticated scan.

**Scanning account**

A scanning account is required to remotely access the devices. This must be a [Group Managed Service Account (gMsa)](/windows-server/security/group-managed-service-accounts/group-managed-service-accounts-overview/). To create a gMsa account:

1. On your domain controller in a PowerShell window, run: *New-ADServiceAccount -name gmsa1 -PrincipalsAllowedToRetrieveManagedPassword scanner-win11-i$ -KerberosEncryptionType RC4, AES128, AES256 –verbose*
    - gmsa1 stands for the name of the account you are creating, and scanner-win11-I$ stands for the machine name where the scanner agent will run. Only this machine will be able to retrieve the account password. You can provide a comma separated list of machines
    - Modifying an existing account can be done with *Get-ADServiceAccount and Set-ADServiceAccount*

On the machine where the scanner agent will run, using an elevated PowerShell window, run: *Install-ADServiceAccount -Identity gmsa1* to test the account.

If your PowerShell doesn’t recognize those commands, it probably means you are missing a required PowerShell module. Instructions on how to install the module vary depending on your OS. For more information, see [Powershell reference documentation](learn.microsoft.com/powershell/module/activedirectory/?view=windowsserver2022-ps/).


**Devices to be scanned**

Use the table below for guidance on configuration requirements on the devices to be scanned.

| Device to scanned requirements | Description |
|:---|:---|
|Windows Management Instrumentation (WMI) and Registry enabled| To enable remote Windows Management Instrumentation (WMI): </br> - Verify the Windows Management Instrumentation service is running. </br> - Go to **Control Panel** &gt; **All Control Panel Items** &gt; **Windows Defender Firewall** &gt; **Allowed applications** and ensure Windows Management Instrumentation (WMI) is allowed through Windows Firewall.|
|Member of **Performance Monitor Users** group| The scanning account is a member of **Performance Monitor Users** group|
|**Performance Monitor Users** group has ‘Enable Account’ and ‘Remote Enable’ permissions on Root/CIMV2 WMI namespace | To verify or enable these permissions: </br> - Run wmimgmt.msc </br> - Right click WMI Control (Local) and choose Properties</br> - Go to Security tab</br> - Select relevant WMI namespace and click Security</br> - Add the specified group and allow the specific permissions</br> - Click Advanced, select the specified group and click edit</br> - Set “Applies To” to “This namespace and subnamespaces”|
|**Performance Monitor Users** group should have permissions on DCOM operations| To verify or enable these permissions: </br> - Run dcomcnfg </br> - Navigate to Component Services -&gt; Computers -&gt; My Computer </br> - Right click My Computer and choose Properties </br> - Go to COM Security tab </br> - Access Permissions -&gt; Edit Limits -&gt; add the specified group and allow “Remote Access” </br> - Launch and Activation Permissions -&gt; Edit Limits -&gt; add the specified group and allow “Remote Launch” and “Remote Activation” |
| **Performance Monitor Users** group should have permissions to perform WMI operations via DCOM protocol| To verify or enable these permissions: </br> - Run dcomcnfg </br> - Navigate to Component Services -&gt; Computers -&gt; My Computer -&gt; DCOM config </br> - Right click “Windows Management and Instrumentation” and choose Properties </br> - Go to Security tab </br> - Edit “Launch and Activation Permissions”  </br> - Add the specified group and allow “Remote Launch” and “Remote Activation”  </br> -

## Scan Job configuration via Portal

Once you have completed all the pre-requisites, to configure a Windows assessment job go to:

1. **Settings** -&gt; **Device discovery** -&gt; **Authenticated scans**
2. Select **Add new scan** and choose **Windows authenticated scan**:
  
    <img src="C:\GitHub\microsoft-365-docs-pr\microsoft-365\security\defender-vulnerability-management\media\image2.png" style="width:5.58333in;height:1.20972in" />

3. Select **Next** and fill in the scan details
    - **Assessment name:** Enter a name for the assessment job
    - **Scanning device:** Choose the onboarded device you'll use to scan the unmanaged devices
    - **Target (range):** Enter the IP addresses\\range you want to scan
    - **Scan interval:** By default, the scan will run every hour, you can change the scan interval or have it only run once, by selecting ‘Do not repeat’
    - **Authentication method:** Choose your authentication method and enter the credentials Microsoft Defender Vulnerability Management will use to remotely access the devices. There are two options to choose form:  
        - Kerberos (preferred)
        - Negotiate (Negotiate option will fallback to NTLM in case Kerberos fails. Using NTLM is not recommended as it is not a secure protocol)
    - Enter credentials:
    - **Use azure key vault:** if you manage your credentials in Azure Key Vault you can enter the Key Vault URL and Secret Name to be accessed by the scanner device to provide credentials
    - **Enter [gMSA credentials](https://learn.microsoft.com/en-us/windows-server/security/group-managed-service-accounts/group-managed-service-accounts-overview):** input the Domain (optional) and Username
4. Select **Next**  
    <img src="C:\GitHub\microsoft-365-docs-pr\microsoft-365\security\defender-vulnerability-management\media\image3.png" style="width:5in;height:3.07292in" />
5. Run or skip the test scan
6.  Select **Submit** to create your assessment job

## Scan job configuration via API (Applies to both Windows authenticated scan and network device scanning)

Use the security portal ApiExplorer or Postman to test API requests:

-  GET <https://api-us.securitycenter.microsoft.com/api/DeviceAuthenticatedScanAgents> - view all scan agents.

-  GET [https://api-us.securitycenter.microsoft.com/api/DeviceAuthenticatedScanDefinitions](https://nam06.safelinks.protection.outlook.com/?url=https%3A%2F%2Fapi-us.securitycenter.microsoft.com%2Fapi%2FDeviceAuthenticatedScanDefinitions&data=05%7C01%7CSaar.Scheinkman%40microsoft.com%7C67a737444e1b4ff528a908da336ef9e5%7C72f988bf86f141af91ab2d7cd011db47%7C1%7C0%7C637878849050854719%7CUnknown%7CTWFpbGZsb3d8eyJWIjoiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C3000%7C%7C%7C&sdata=gNFZmMG24iYxWB%2BCXXiD4dW%2BOw3g3OmzGfZkQJSEpJ4%3D&reserved=0) - view all scan definitions.

-  POST [https://api-us.securitycenter.microsoft.com/api/DeviceAuthenticatedScanDefinitions](https://nam06.safelinks.protection.outlook.com/?url=https%3A%2F%2Fapi-us.securitycenter.microsoft.com%2Fapi%2FDeviceAuthenticatedScanDefinitions&data=05%7C01%7CSaar.Scheinkman%40microsoft.com%7C67a737444e1b4ff528a908da336ef9e5%7C72f988bf86f141af91ab2d7cd011db47%7C1%7C0%7C637878849050854719%7CUnknown%7CTWFpbGZsb3d8eyJWIjoiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C3000%7C%7C%7C&sdata=gNFZmMG24iYxWB%2BCXXiD4dW%2BOw3g3OmzGfZkQJSEpJ4%3D&reserved=0) - add a new scan definition.

    -   Change ‘api-us’ to ‘api-eu’/’api-uk’ according to your tenant’s geo-region.

-   Message bodies (Network & Windows authenticated scans) for example:

{

    "scanType": "Network",

    "scanName": "Test Network scan",

    "isActive": true,

    "target": "127.0.0.1",

“intervalInHours”: 4,

    "scannerAgent": {

        "machineId": "896226a67c5e2917e44fb5c0368dc6c83129c5bf"

    },

    "scanAuthenticationParams": {

        "@odata.type": "\#microsoft.windowsDefenderATP.api.SnmpAuthParams",

        "type": "AuthPriv",

        "username": "username",

        "authProtocol": "authProtocol",

        "authPassword": "authPassword",

        "privProtocol": "privProtocol",

        "privPassword": "privPassword",

        "communityString": "community-string"

    }

}

 

{

    "scanType": "Windows",

    "scanName": "Test Windows scan",

    "isActive": true,

    "target": "127.0.0.1",

“intervalInHours”: 4,

    "scannerAgent": {

        "machineId": "896226a67c5e2917e44fb5c0368dc6c83129c5bf"

    },

    "scanAuthenticationParams": {

        "@odata.type": "\#microsoft.windowsDefenderATP.api.WindowsAuthParams",

        "type": "Kerberos",

        "username": "username",

        "password": "password"

    }

}

> \* PATCH / DELETE APIs will be added later.

You can also provide the username/password through Azure KeyVault instead of passing them directly in the API call.

This can be achieved by replacing the username & password fields above with (example values):

"KeyVaultUri": "<https://vaultname.vault.azure.net>",

"KeyVaultSecretName": "windowsNtlmCredentials",

The secret’s format should be as follows: Domain;Username;Password \[e.g Microsoft;Admin;1234\]

In order for the scanner agent to be able to access the secret, add a ‘Secret Get’ access policy for the agent-specific AppIds named ‘Application to manage WDATP TVM Network scan agent XXX’, like so:

<img src="C:\GitHub\microsoft-365-docs-pr\microsoft-365\security\defender-vulnerability-management\media\image4.png" style="width:5.60703in;height:3.65625in" />

Step-by-step documentation: <https://docs.microsoft.com/en-us/azure/key-vault/general/assign-access-policy?tabs=azure-portal>

After successfully creating a scan, it will run periodically every 60 minutes. You can use the GET API to see the scan status and latest runs. Once successful scans are completed, you should be able to see the new data for scanned devices in the device inventory under the relevant tab (Computers & Mobile / Network Devices):  
<img src="C:\GitHub\microsoft-365-docs-pr\microsoft-365\security\defender-vulnerability-management\media\image5.png" style="width:5.45834in;height:3.13542in" alt="Graphical user interface, application, email Description automatically generated" />
