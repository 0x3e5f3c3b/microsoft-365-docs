---
title: View and edit your security settings in Microsoft Defender for Business
description: View and edit security policies and settings in Defender for Business
search.appverid: MET150
author: siosulli
ms.author: siosulli
manager: dansimp
audience: Admin
ms.topic: conceptual
ms.service: microsoft-365-security
ms.subservice: mdvm
ms.localizationpriority: medium
ms.date: 05/12/2022
ms.collection:
 - m365-security
 - m365-security-compliance
 - tier1

---

# Windows authenticated scan


[!INCLUDE [Microsoft 365 Defender rebranding](../../includes/microsoft-defender.md)]

**Applies to:**

- [Microsoft Defender for Endpoint Plan 2](https://go.microsoft.com/fwlink/?linkid=2154037)
- [Microsoft Defender Vulnerability Management](index.yml)
- [Microsoft 365 Defender](https://go.microsoft.com/fwlink/?linkid=2118804)

[!include[Prerelease information](../../includes/prerelease.md)]

>[!Note]
> Want to experience Microsoft Defender Vulnerability Management? Learn more about how you can sign up to the [Microsoft Defender Vulnerability Management public preview trial](../defender-vulnerability-management/get-defender-vulnerability-management.md).

Windows authenticated scan provides the ability to remotely target by IP ranges and scan Windows services by providing Microsoft Defender Vulnerability Management with credentials to remotely access the machines.

This is applicable for devices that do not have the Defender Vulnerability Management or Defender for Endpoint agent deployed.

## Scanner Installation

>
>[!Note]: pre-existing scanners do not require any change**

If you don’t already have the network scanner installed, you can follow the steps on how the authenticated network scanner is installed today. For more information, see [Network device discovery and vulnerability management.](https://docs.microsoft.com/microsoft-365/security/defender-endpoint/network-devices?view=o365-worldwide#install-the-network-scanner)

## Requirements

The following table lists the basic requirements you need to configure and use Windows authenticated scan.

| Requirement | Description |
|:---|:---|
| A scanning account | Must be a [Group Managed Service Account (gMsa)](/windows-server/security/group-managed-service-accounts/group-managed-service-accounts-overview/) </p> On your domain controller in a PowerShell window, run: *New-ADServiceAccount -name gmsa1 -PrincipalsAllowedToRetrieveManagedPassword scanner-win11-i$ -KerberosEncryptionType RC4, AES128, AES256 –verbose* </p> </li><li> gmsa1 stands for the name of the account you are creating, and scanner-win11-I$ stands for the machine name where the scanner agent will run. Only this machine will be able to retrieve the account password. You can provide a comma separated list of machines. </li><li> Modifying an existing account can be done with *Get-ADServiceAccount and Set-ADServiceAccount* </p></p> On the machine where the scanner agent will run, using an elevated PowerShell window, run: *Install-ADServiceAccount -Identity gmsa1*</p> </li><li> You can test with *Test-ADServiceAccount -Identity gmsa1*. </li><li> If your PowerShell doesn’t recognize those commands, it probably means you are missing a required PowerShell module. Instructions on how to install the module vary depending on your OS. Some instructions can be found [here](/powershell/module/activedirectory/?view=windowsserver2022-ps/)|


| Datacenter | One of the following datacenter locations: <ul><li>European Union</li><li>United Kingdom</li><li>United States</li></ul> |
| User accounts |<ul><li>User accounts are created in the Microsoft 365 admin center ([https://admin.microsoft.com](https://admin.microsoft.com)).</li><li>Licenses for Defender for Business (or Microsoft 365 Business Premium) are assigned in the Microsoft 365 admin center.</li></ul>To get help with this task, see [Add users and assign licenses](mdb-add-users.md). |
| Permissions  | To sign up for Defender for Business, you must be a Global Admin.<br/><br/>To access the Microsoft 365 Defender portal, users must have one of the following [roles in Azure AD](mdb-roles-permissions.md) assigned:<ul><li>Security Reader</li><li>Security Admin</li><li>Global Admin</li></ul>To learn more, see [Roles and permissions in Defender for Business](mdb-roles-permissions.md). |
| Browser requirements | Microsoft Edge or Google Chrome |
| Client device operating system | To manage devices in the Microsoft 365 Defender portal, your devices must be running one of the following operating systems: <ul><li>Windows 10 or 11 Business</li><li>Windows 10 or 11 Professional</li><li>Windows 10 or 11 Enterprise</li><li>Mac (the three most-current releases are supported)</li></ul>Make sure that [KB5006738](https://support.microsoft.com/topic/october-26-2021-kb5006738-os-builds-19041-1320-19042-1320-and-19043-1320-preview-ccbce6bf-ae00-4e66-9789-ce8e7ea35541) is installed on the Windows devices. <br/><br/>If you're already managing devices in Microsoft Intune, you can continue to use the Microsoft Endpoint Manager admin center.<sup>[[1](#fn1)]</sup> In that case, the following other operating systems are supported: <ul><li>iOS and iPadOS</li><li>Android OS</li></ul> |
| Server requirements | To onboard a device running Windows Server or Linux Server, you'll need an additional license, such as [Microsoft Defender for Business servers](get-defender-business-servers.md)<sup>[[2](#fn2)]</sup>.<br/><br/>Windows Server endpoints must meet the [requirements for Defender for Endpoint](/microsoft-365/security/defender-endpoint/minimum-requirements#hardware-and-software-requirements), and enforcement scope must be turned on.<ol><li>In the Microsoft 365 Defender portal, go to **Settings** > **Endpoints** > **Configuration management** > **Enforcement scope**.</li><li>Select **Use MDE to enforce security configuration settings from MEM**, select  **Windows Server**. </li><li>Select **Save**.</li></ol>Linux Server endpoints must meet the [prerequisites for Microsoft Defender for Endpoint on Linux](../defender-endpoint/microsoft-defender-endpoint-linux.md#prerequisites).|



You'll need a scanning account - this must be a [Group Managed Service Account (gMsa)](/windows-server/security/group-managed-service-accounts/group-managed-service-accounts-overview/). To create such an account, you’ll need to:

1. On your domain controller in a PowerShell window, run: *New-ADServiceAccount -name gmsa1 -PrincipalsAllowedToRetrieveManagedPassword scanner-win11-i$ -KerberosEncryptionType RC4, AES128, AES256 –verbose*
     - gmsa1 stands for the name of the account you are creating, and scanner-win11-I$ stands for the machine name where the scanner agent will run. Only this machine will be able to retrieve the account password. You can provide a comma separated list of machines.
     - Modifying an existing account can be done with *Get-ADServiceAccount and Set-ADServiceAccount*

2. On the machine where the scanner agent will run, using an elevated PowerShell window, run: *Install-ADServiceAccount -Identity gmsa1*

     - You can test with *Test-ADServiceAccount -Identity gmsa1*
     - If your PowerShell doesn’t recognize those commands, it probably means you are missing a required PowerShell module. Instructions on how to install the module vary depending on your OS. Some instructions can be found [here](https://learn.microsoft.com/en-us/powershell/module/activedirectory/?view=windowsserver2022-ps).

-   <u>Scanned devices</u> require remote Windows Management Instrumentation (WMI) and Registry enabled:

1.  Windows Management Instrumentation service should be up

2.  Go to Control Panel &gt; All Control Panel Items &gt; Windows Defender Firewall &gt; Allowed applications and ensure Windows Management Instrumentation (WMI) is allowed through Windows Firewall:

> <img src="C:\GitHub\microsoft-365-docs-pr\microsoft-365\security\defender-vulnerability-management\media\image1.png" style="width:5.57253in;height:3.75532in" alt="Graphical user interface, text Description automatically generated" />

3.  The user is a member of **Performance Monitor Users** group

4.  The **Performance Monitor Users** group has ‘Enable Account’ and ‘Remote Enable’ permissions on Root/CIMV2 WMI namespace

    1.  Run wmimgmt.msc

    2.  Right click WMI Control (Local) and choose Properties

    3.  Go to Security tab

    4.  Select relevant WMI namespace and click Security

    5.  Add the specified group and allow the specific permissions

    6.  Click Advanced, select the specified group and click edit

    7.  Set “Applies To” to “This namespace and subnamespaces”

5.  **Performance Monitor Users** group should have permissions on DCOM operations

    1.  Run dcomcnfg

    2.  Navigate to Component Services -&gt; Computers -&gt; My Computer

    3.  Right click My Computer and choose Properties

    4.  Go to COM Security tab

    5.  Access Permissions -&gt; Edit Limits -&gt; add the specified group and allow “Remote Access”

    6.  Launch and Activation Permissions -&gt; Edit Limits -&gt; add the specified group and allow “Remote Launch” and “Remote Activation”

6.  **Performance Monitor Users** group should have permissions to perform WMI operations via DCOM protocol

    1.  Run dcomcnfg

    2.  Navigate to Component Services -&gt; Computers -&gt; My Computer -&gt; DCOM config

    3.  Right click “Windows Management and Instrumentation” and choose Properties

    4.  Go to Security tab

    5.  Edit “Launch and Activation Permissions”

    6.  Add the specified group and allow “Remote Launch” and “Remote Activation”

## Scan Job configuration via Portal

Once you have completed all the pre-requisites, to configure a Windows assessment job go to:

1.  **Settings** -&gt; **Device discovery** -&gt; **Authenticated scans**

2.  Select **Add new scan** and choose **Windows authenticated scan**:  
    <img src="C:\GitHub\microsoft-365-docs-pr\microsoft-365\security\defender-vulnerability-management\media\image2.png" style="width:5.58333in;height:1.20972in" />

3.  Select **Next** and fill in the scan details

    1.  **Assessment name:** Enter a name for the assessment job

    2.  **Scanning device:** Choose the onboarded device you'll use to scan the unmanaged devices

    3.  **Target (range):** Enter the IP addresses\\range you want to scan

    4.  **Scan interval:** By default, the scan will run every hour, you can change the scan interval or have it only run once, by selecting ‘Do not repeat’

    5.  **Authentication method:** Choose your authentication method and enter the credentials Microsoft Defender Vulnerability Management will use to remotely access the devices  
        There are two options to choose form:  
        - Kerberos (preferred)

> \- Negotiate (Negotiate option will fallback to NTLM in case Kerberos fails. Using NTLM is not recommended as it is not a secure protocol)

6.  Enter credentials:

    -   **Use azure key vault:** if you manage your credentials in Azure Key Vault you can enter the Key Vault URL and Secret Name to be accessed by the scanner device to provide credentials

    -   **Enter [gMSA credentials](https://learn.microsoft.com/en-us/windows-server/security/group-managed-service-accounts/group-managed-service-accounts-overview):** input the Domain (optional) and Username

<!-- -->

4.  Select **Next**  
    <img src="C:\GitHub\microsoft-365-docs-pr\microsoft-365\security\defender-vulnerability-management\media\image3.png" style="width:5in;height:3.07292in" />

5.  Run or skip the test scan

6.  Select **Submit** to create your assessment job

## Scan job configuration via API (Applies to both Windows authenticated scan and network device scanning)

Use the security portal ApiExplorer or Postman to test API requests:

-   GET <https://api-us.securitycenter.microsoft.com/api/DeviceAuthenticatedScanAgents> - view all scan agents.

-   GET [https://api-us.securitycenter.microsoft.com/api/DeviceAuthenticatedScanDefinitions](https://nam06.safelinks.protection.outlook.com/?url=https%3A%2F%2Fapi-us.securitycenter.microsoft.com%2Fapi%2FDeviceAuthenticatedScanDefinitions&data=05%7C01%7CSaar.Scheinkman%40microsoft.com%7C67a737444e1b4ff528a908da336ef9e5%7C72f988bf86f141af91ab2d7cd011db47%7C1%7C0%7C637878849050854719%7CUnknown%7CTWFpbGZsb3d8eyJWIjoiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C3000%7C%7C%7C&sdata=gNFZmMG24iYxWB%2BCXXiD4dW%2BOw3g3OmzGfZkQJSEpJ4%3D&reserved=0) - view all scan definitions.

-   POST [https://api-us.securitycenter.microsoft.com/api/DeviceAuthenticatedScanDefinitions](https://nam06.safelinks.protection.outlook.com/?url=https%3A%2F%2Fapi-us.securitycenter.microsoft.com%2Fapi%2FDeviceAuthenticatedScanDefinitions&data=05%7C01%7CSaar.Scheinkman%40microsoft.com%7C67a737444e1b4ff528a908da336ef9e5%7C72f988bf86f141af91ab2d7cd011db47%7C1%7C0%7C637878849050854719%7CUnknown%7CTWFpbGZsb3d8eyJWIjoiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C3000%7C%7C%7C&sdata=gNFZmMG24iYxWB%2BCXXiD4dW%2BOw3g3OmzGfZkQJSEpJ4%3D&reserved=0) - add a new scan definition.

    -   Change ‘api-us’ to ‘api-eu’/’api-uk’ according to your tenant’s geo-region.

-   Message bodies (Network & Windows authenticated scans) for example:

{

    "scanType": "Network",

    "scanName": "Test Network scan",

    "isActive": true,

    "target": "127.0.0.1",

“intervalInHours”: 4,

    "scannerAgent": {

        "machineId": "896226a67c5e2917e44fb5c0368dc6c83129c5bf"

    },

    "scanAuthenticationParams": {

        "@odata.type": "\#microsoft.windowsDefenderATP.api.SnmpAuthParams",

        "type": "AuthPriv",

        "username": "username",

        "authProtocol": "authProtocol",

        "authPassword": "authPassword",

        "privProtocol": "privProtocol",

        "privPassword": "privPassword",

        "communityString": "community-string"

    }

}

 

{

    "scanType": "Windows",

    "scanName": "Test Windows scan",

    "isActive": true,

    "target": "127.0.0.1",

“intervalInHours”: 4,

    "scannerAgent": {

        "machineId": "896226a67c5e2917e44fb5c0368dc6c83129c5bf"

    },

    "scanAuthenticationParams": {

        "@odata.type": "\#microsoft.windowsDefenderATP.api.WindowsAuthParams",

        "type": "Kerberos",

        "username": "username",

        "password": "password"

    }

}

> \* PATCH / DELETE APIs will be added later.

You can also provide the username/password through Azure KeyVault instead of passing them directly in the API call.

This can be achieved by replacing the username & password fields above with (example values):

"KeyVaultUri": "<https://vaultname.vault.azure.net>",

"KeyVaultSecretName": "windowsNtlmCredentials",

The secret’s format should be as follows: Domain;Username;Password \[e.g Microsoft;Admin;1234\]

In order for the scanner agent to be able to access the secret, add a ‘Secret Get’ access policy for the agent-specific AppIds named ‘Application to manage WDATP TVM Network scan agent XXX’, like so:

<img src="C:\GitHub\microsoft-365-docs-pr\microsoft-365\security\defender-vulnerability-management\media\image4.png" style="width:5.60703in;height:3.65625in" />

Step-by-step documentation: <https://docs.microsoft.com/en-us/azure/key-vault/general/assign-access-policy?tabs=azure-portal>

After successfully creating a scan, it will run periodically every 60 minutes. You can use the GET API to see the scan status and latest runs. Once successful scans are completed, you should be able to see the new data for scanned devices in the device inventory under the relevant tab (Computers & Mobile / Network Devices):  
<img src="C:\GitHub\microsoft-365-docs-pr\microsoft-365\security\defender-vulnerability-management\media\image5.png" style="width:5.45834in;height:3.13542in" alt="Graphical user interface, application, email Description automatically generated" />
